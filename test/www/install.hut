<?
MODU inc/conn;

var pin = asynEchoPrepare();

try {
	var locked = require('./install.lock.js').locked;
	if (locked === 'no') {
		var db = openDB();

		db.serialize(function(){
			
			for (var name in DB_TABLES) createTable(db, name, DB_TABLES[name]);
			
			dbInsert(db, 'user', {name:'admin', pass:'admin'}, function(err){
				if (err) asynEcho(pin, 'DB ERR: ' + err);
				asynEcho(pin, '安装完毕');
			});
			
			db.close();
		});
	
	} else {
		?>
		<h3>不能进行安装</h3>
		<p>安装文件已被锁定（这通常是由于程序已经安装完毕造成的）。</p>
		<?
	}
} catch(e) {
	?>
	<h3>安装失败</h3>
	<p>异常描述：</p>
	<ul>
	<?for (var i in e) echo('<li>' + i + ":" + e[i] + '</li>'); ?>
	</ul>
	<?
	asynEcho(pin, 'Complete');
}

?>
